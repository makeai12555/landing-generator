<!DOCTYPE html>
<html class="light" dir="rtl" lang="he">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>CourseFlow - הגדרת דף נחיתה</title>

    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&amp;family=Noto+Sans+Hebrew:wght@400;500;700&amp;display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
      rel="stylesheet"
    />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#13ecda",
              "primary-hover": "#0ddbc9",
              "background-light": "#f6f8f8",
              "background-dark": "#102220",
              "text-main": "#111817",
              "text-muted": "#618986",
              "border-color": "#dbe6e5",
            },
            fontFamily: {
              display: ["Inter", "Noto Sans Hebrew", "sans-serif"],
              sans: ["Inter", "Noto Sans Hebrew", "sans-serif"],
            },
            borderRadius: {
              DEFAULT: "0.25rem",
              lg: "0.5rem",
              xl: "0.75rem",
              "2xl": "1rem",
              full: "9999px",
            },
          },
        },
      };
    </script>

    <style>
      body {
        font-family: "Inter", "Noto Sans Hebrew", sans-serif;
      }
      .toggle-checkbox:checked {
        right: 0;
        border-color: #13ecda;
      }
      .toggle-checkbox:checked + .toggle-label {
        background-color: #13ecda;
      }
    </style>

    <script>
      let courseData = null;

      function loadCourseData() {
        const saved = localStorage.getItem("courseData");
        if (!saved) {
          alert("לא נמצאו נתוני קורס. חזור לשלב 1.");
          window.location.href = "/";
          return;
        }
        courseData = JSON.parse(saved);
        renderPreview();
      }

      function renderPreview() {
        if (!courseData) return;

        const details = courseData.course_details || {};
        const assets = courseData.generated_assets || {};

        // Course title
        document.getElementById("previewTitle").textContent = details.title || "שם הקורס";
        document.getElementById("previewDescription").textContent = details.description || "";

        // Schedule info
        const schedule = details.schedule || {};
        document.getElementById("previewDates").textContent = schedule.dates || "-";
        document.getElementById("previewTime").textContent = schedule.time || "-";
        document.getElementById("previewDays").textContent = schedule.days || "-";
        document.getElementById("previewLocation").textContent = details.location || "-";
        document.getElementById("previewDuration").textContent = details.duration || "-";
        document.getElementById("previewAudience").textContent = details.target_audience || "-";

        // Banner preview
        if (assets.banner_url) {
          document.getElementById("bannerPreview").src = assets.banner_url;
          document.getElementById("bannerPreview").classList.remove("hidden");
          document.getElementById("noBannerMsg").classList.add("hidden");
        }

        // Background preview (English image for landing page)
        if (assets.background_url) {
          document.getElementById("backgroundPreview").src = assets.background_url;
          document.getElementById("backgroundPreview").classList.remove("hidden");
          document.getElementById("noBackgroundMsg").classList.add("hidden");
        }

        // Load landing config if exists
        const landingConfig = courseData.landing_config || {};
        if (landingConfig.extended_description) {
          document.getElementById("extendedDescription").value = landingConfig.extended_description;
        }
        if (landingConfig.requires_interview) {
          document.getElementById("requiresInterview").checked = true;
        }
      }

      function updateLandingConfig() {
        const requiresInterview = document.getElementById("requiresInterview").checked;
        const extendedDescription = document.getElementById("extendedDescription").value;

        courseData.landing_config = courseData.landing_config || {};
        courseData.landing_config.requires_interview = requiresInterview;
        courseData.landing_config.extended_description = extendedDescription;
        courseData.landing_config.referral_options = ["חבר/ה", "פייסבוק", "גוגל", "אחר"];

        localStorage.setItem("courseData", JSON.stringify(courseData));
      }

      async function createLandingPage() {
        updateLandingConfig();

        const btn = document.getElementById("createLandingBtn");
        const originalHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = "יוצר דף נחיתה...";

        try {
          const response = await fetch("/api/create-landing", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ courseData }),
          });

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.error || "Failed to create landing page");
          }

          // Save landing page ID
          localStorage.setItem("landingPageId", result.landingId);

          // Navigate to landing page
          window.location.href = `/landing/${result.landingId}`;
        } catch (error) {
          console.error("Error creating landing page:", error);
          alert(`שגיאה ביצירת דף נחיתה: ${error.message}`);
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalHTML;
        }
      }

      function goBack() {
        window.location.href = "/";
      }

      window.addEventListener("DOMContentLoaded", loadCourseData);
    </script>
  </head>

  <body class="bg-background-light dark:bg-background-dark text-text-main dark:text-white min-h-screen flex flex-col">
    <header
      class="sticky top-0 z-50 bg-white dark:bg-[#1a2e2c] border-b border-border-color dark:border-white/10 px-6 py-3 shadow-sm"
    >
      <div class="max-w-7xl mx-auto flex items-center justify-between">
        <div class="flex items-center gap-4 text-text-main dark:text-white">
          <div class="size-8 text-primary">
            <svg class="w-full h-full" fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
              <path
                clip-rule="evenodd"
                d="M47.2426 24L24 47.2426L0.757355 24L24 0.757355L47.2426 24ZM12.2426 21H35.7574L24 9.24264L12.2426 21Z"
                fill="currentColor"
                fill-rule="evenodd"
              ></path>
            </svg>
          </div>
          <h2 class="text-xl font-bold tracking-tight">CourseFlow</h2>
        </div>
      </div>
    </header>

    <main class="flex-1 w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Progress Bar -->
      <div class="mb-10 max-w-4xl mx-auto">
        <div class="flex flex-col gap-3">
          <div class="flex justify-between items-end">
            <div>
              <p class="text-text-main dark:text-white text-lg font-bold">יצירת דף נחיתה</p>
              <p class="text-text-muted text-sm">שלב 2 מתוך 2: הגדרות דף נחיתה</p>
            </div>
            <span class="text-primary text-sm font-bold">100%</span>
          </div>
          <div class="h-2 w-full bg-border-color dark:bg-white/10 rounded-full overflow-hidden">
            <div class="h-full bg-primary rounded-full" style="width: 100%"></div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Left: Settings -->
        <div class="space-y-6">
          <!-- Course Summary Card -->
          <div class="bg-white dark:bg-[#1a2e2c] rounded-2xl p-6 shadow-sm border border-border-color dark:border-white/5">
            <h2 class="text-xl font-bold text-text-main dark:text-white mb-4">סיכום הקורס</h2>

            <div class="space-y-4">
              <div>
                <h3 id="previewTitle" class="text-lg font-bold text-text-main dark:text-white">שם הקורס</h3>
                <p id="previewDescription" class="text-sm text-text-muted mt-1"></p>
              </div>

              <div class="grid grid-cols-2 gap-4 pt-4 border-t border-border-color dark:border-white/10">
                <div>
                  <p class="text-xs text-text-muted">תאריכים</p>
                  <p id="previewDates" class="text-sm font-medium text-text-main dark:text-white">-</p>
                </div>
                <div>
                  <p class="text-xs text-text-muted">שעות</p>
                  <p id="previewTime" class="text-sm font-medium text-text-main dark:text-white">-</p>
                </div>
                <div>
                  <p class="text-xs text-text-muted">ימים</p>
                  <p id="previewDays" class="text-sm font-medium text-text-main dark:text-white">-</p>
                </div>
                <div>
                  <p class="text-xs text-text-muted">מיקום</p>
                  <p id="previewLocation" class="text-sm font-medium text-text-main dark:text-white">-</p>
                </div>
                <div>
                  <p class="text-xs text-text-muted">משך</p>
                  <p id="previewDuration" class="text-sm font-medium text-text-main dark:text-white">-</p>
                </div>
                <div>
                  <p class="text-xs text-text-muted">קהל יעד</p>
                  <p id="previewAudience" class="text-sm font-medium text-text-main dark:text-white">-</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Landing Page Settings -->
          <div class="bg-white dark:bg-[#1a2e2c] rounded-2xl p-6 shadow-sm border border-border-color dark:border-white/5">
            <h2 class="text-xl font-bold text-text-main dark:text-white mb-4">הגדרות דף נחיתה</h2>

            <div class="space-y-6">
              <!-- Extended Description -->
              <div>
                <label class="block text-sm font-semibold text-text-main dark:text-white mb-2">
                  מידע נוסף על הקורס
                </label>
                <p class="text-xs text-text-muted mb-2">מידע מורחב שיופיע בדף הנחיתה (סילבוס, דרישות קדם, מה נלמד...)</p>
                <textarea
                  id="extendedDescription"
                  rows="6"
                  class="w-full p-4 rounded-lg border border-border-color bg-white dark:bg-black/20 dark:border-white/10 text-text-main dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all resize-none placeholder:text-text-muted/50"
                  placeholder="למשל:&#10;&#10;מה נלמד בקורס:&#10;• יסודות HTML ו-CSS&#10;• JavaScript מתחילים&#10;• בניית אתר אמיתי&#10;&#10;דרישות קדם: אין! מתאים למתחילים מוחלטים"
                  onchange="updateLandingConfig()"
                ></textarea>
              </div>

              <!-- Interview Toggle -->
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-semibold text-text-main dark:text-white">נדרש ראיון קבלה</p>
                  <p class="text-xs text-text-muted mt-1">אם מופעל, יתווסף שדה "זמינות לראיון" בטופס</p>
                </div>
                <div class="relative inline-block w-12 align-middle select-none">
                  <input
                    type="checkbox"
                    id="requiresInterview"
                    class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 border-gray-300 appearance-none cursor-pointer transition-all duration-200"
                    style="top: 2px; right: 2px;"
                    onchange="updateLandingConfig()"
                  />
                  <label
                    for="requiresInterview"
                    class="toggle-label block overflow-hidden h-7 rounded-full bg-gray-300 cursor-pointer transition-all duration-200"
                  ></label>
                </div>
              </div>

              <!-- Referral Options (read-only for now) -->
              <div>
                <p class="text-sm font-semibold text-text-main dark:text-white mb-2">אפשרויות "איך הגעת אלינו"</p>
                <div class="flex flex-wrap gap-2">
                  <span class="px-3 py-1 bg-border-color/50 dark:bg-white/10 rounded-full text-xs text-text-muted">חבר/ה</span>
                  <span class="px-3 py-1 bg-border-color/50 dark:bg-white/10 rounded-full text-xs text-text-muted">פייסבוק</span>
                  <span class="px-3 py-1 bg-border-color/50 dark:bg-white/10 rounded-full text-xs text-text-muted">גוגל</span>
                  <span class="px-3 py-1 bg-border-color/50 dark:bg-white/10 rounded-full text-xs text-text-muted">אחר</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
            <button
              class="w-full sm:w-auto px-6 h-12 rounded-lg border border-border-color text-text-muted hover:text-text-main hover:border-text-main font-medium transition-colors cursor-pointer"
              onclick="goBack()"
              type="button"
            >
              <span class="material-symbols-outlined rtl:rotate-180 align-middle">arrow_back</span>
              חזור לשלב 1
            </button>
            <button
              id="createLandingBtn"
              class="w-full sm:w-auto flex items-center justify-center gap-2 px-8 h-12 bg-primary hover:bg-primary-hover text-[#111817] text-base font-bold rounded-lg shadow-sm shadow-primary/20 transition-all transform active:scale-95"
              onclick="createLandingPage()"
              type="button"
            >
              <span>צור דף נחיתה</span>
              <span class="material-symbols-outlined">rocket_launch</span>
            </button>
          </div>
        </div>

        <!-- Right: Preview -->
        <div class="space-y-6">
          <!-- Banner Preview -->
          <div class="bg-white dark:bg-[#1a2e2c] rounded-2xl p-6 shadow-sm border border-border-color dark:border-white/5">
            <h2 class="text-xl font-bold text-text-main dark:text-white mb-4">באנר הקורס</h2>
            <div class="aspect-[16/9] rounded-xl overflow-hidden bg-border-color/40 dark:bg-white/10 flex items-center justify-center">
              <img id="bannerPreview" src="" alt="Banner Preview" class="hidden w-full h-full object-cover" />
              <p id="noBannerMsg" class="text-sm text-text-muted">לא נוצר באנר</p>
            </div>
            <p class="text-xs text-text-muted mt-2">הבאנר העברי המלא - לשיתוף ברשתות חברתיות</p>
          </div>

          <!-- Background Preview -->
          <div class="bg-white dark:bg-[#1a2e2c] rounded-2xl p-6 shadow-sm border border-border-color dark:border-white/5">
            <h2 class="text-xl font-bold text-text-main dark:text-white mb-4">תמונת רקע לדף נחיתה</h2>
            <div class="aspect-[16/9] rounded-xl overflow-hidden bg-border-color/40 dark:bg-white/10 flex items-center justify-center">
              <img id="backgroundPreview" src="" alt="Background Preview" class="hidden w-full h-full object-cover" />
              <p id="noBackgroundMsg" class="text-sm text-text-muted">לא נוצרה תמונת רקע</p>
            </div>
            <p class="text-xs text-text-muted mt-2">התמונה האנגלית - תשמש כרקע ה-Hero בדף הנחיתה</p>
          </div>
        </div>
      </div>
    </main>
  </body>
</html>
